<div class="page-container">
  <div class="page-header">
    <div class="header-content">
      <button class="btn-back" routerLink="/contratos">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd"
          />
        </svg>
        Voltar
      </button>
      <h1>{{ isEdit() ? '‚úèÔ∏è Editar Contrato' : '‚ûï Novo Contrato' }}</h1>
      <p class="subtitle">
        {{
          isEdit()
            ? 'Atualize as informa√ß√µes do contrato'
            : 'Preencha os dados para cadastrar um novo contrato'
        }}
      </p>
    </div>
  </div>

  @if (error()) {
  <div class="alert alert-error">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
      <path
        fill-rule="evenodd"
        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
        clip-rule="evenodd"
      />
    </svg>
    {{ error() }}
  </div>
  }

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-container">
    <div class="form-card">
      <div class="form-group">
        <label for="condominioId" class="form-label">
          Condom√≠nio <span class="required">*</span>
        </label>
        <select
          id="condominioId"
          formControlName="condominioId"
          class="form-input"
          [class.error]="hasError('condominioId')"
          [disabled]="isEdit()"
        >
          <option value="">Selecione um condom√≠nio</option>
          @for (cond of condominios(); track cond.id) {
          <option [value]="cond.id">{{ cond.nome }}</option>
          }
        </select>
        @if (hasError('condominioId')) {
        <span class="error-message">{{ getErrorMessage('condominioId') }}</span>
        }
      </div>

      <div class="form-group">
        <label for="descricao" class="form-label">
          Descri√ß√£o <span class="required">*</span>
        </label>
        <textarea
          id="descricao"
          formControlName="descricao"
          class="form-input"
          [class.error]="hasError('descricao')"
          rows="3"
          placeholder="Ex: Contrato de presta√ß√£o de servi√ßos de vigil√¢ncia"
        >
        </textarea>
        @if (hasError('descricao')) {
        <span class="error-message">{{ getErrorMessage('descricao') }}</span>
        }
      </div>

      <h3 class="section-title">üí∞ Valores Base</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="valorDiariaCobrada" class="form-label">
            Valor Di√°ria por Funcion√°rio (R$) <span class="required">*</span>
            <span class="info-tooltip-wrapper">
              <button
                type="button"
                class="info-tooltip-button"
                (click)="toggleTooltip('valorDiaria')"
                [attr.aria-label]="'Informa√ß√µes sobre Valor da Di√°ria'"
                [attr.aria-expanded]="activeTooltip() === 'valorDiaria'">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
              </button>
              @if (activeTooltip() === 'valorDiaria') {
                <div class="tooltip-content" role="tooltip">
                  <button type="button" class="tooltip-close" (click)="toggleTooltip('valorDiaria')" aria-label="Fechar">√ó</button>
                  <p><strong>Valor da Di√°ria por Funcion√°rio</strong></p>
                  <p>Valor cobrado por dia de trabalho de cada funcion√°rio.</p>
                  <p><strong>Mercado:</strong> R$ 80-150</p>
                  <p><strong>Recomendado:</strong> R$ 100 (m√©dia nacional para portaria)</p>
                </div>
              }
            </span>
          </label>
          <input
            id="valorDiariaCobrada"
            type="number"
            formControlName="valorDiariaCobrada"
            class="form-input"
            [class.error]="hasError('valorDiariaCobrada')"
            placeholder="Ex: 100.00"
            step="0.01"
          />
          @if (hasError('valorDiariaCobrada')) {
          <span class="error-message">{{ getErrorMessage('valorDiariaCobrada') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="quantidadeFuncionarios" class="form-label">
            Quantidade de Funcion√°rios <span class="required">*</span>
            <span class="info-tooltip" title="Total absoluto de funcion√°rios que trabalhar√£o neste condom√≠nio (soma de todos os turnos). Exemplo: 6 funcion√°rios no turno diurno + 6 no noturno = 12 funcion√°rios total.">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </span>
          </label>
          <input
            id="quantidadeFuncionarios"
            type="number"
            formControlName="quantidadeFuncionarios"
            class="form-input"
            [class.error]="hasError('quantidadeFuncionarios')"
            placeholder="Ex: 12 (total de todos os turnos)"
            step="1"
            min="1"
          />
          @if (hasError('quantidadeFuncionarios')) {
          <span class="error-message">{{ getErrorMessage('quantidadeFuncionarios') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="numeroDePostos" class="form-label">
            N√∫mero de Postos de Trabalho <span class="required">*</span>
            <span class="info-tooltip" title="Quantidade de turnos/postos diferentes. Exemplos: 2 postos = turnos de 12h (diurno/noturno), 3 postos = turnos de 8h, 4 postos = turnos de 6h. Padr√£o recomendado: 2 postos (escala 12x36).">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </span>
          </label>
          <input
            id="numeroDePostos"
            type="number"
            formControlName="numeroDePostos"
            class="form-input"
            [class.error]="hasError('numeroDePostos')"
            placeholder="Ex: 2 (padr√£o 12x36)"
            step="1"
            min="1"
            max="6"
          />
          @if (hasError('numeroDePostos')) {
          <span class="error-message">{{ getErrorMessage('numeroDePostos') }}</span>
          }
          <small class="field-hint">
            üí° 2 postos = 12h cada (padr√£o) | 3 postos = 8h cada | 4 postos = 6h cada
          </small>
        </div>
      <div class="form-group">
        <label for="valorBeneficiosExtrasMensal" class="form-label">
          Benef√≠cios Extras Mensais (R$) <span class="required">*</span>
          <span class="info-tooltip" title="Valor total mensal de benef√≠cios como vale-transporte, vale-alimenta√ß√£o, plano de sa√∫de, etc. Valor recomendado: R$ 350-500/funcion√°rio.">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          </span>
        </label>
        <input
          id="valorBeneficiosExtrasMensal"
          type="number"
          formControlName="valorBeneficiosExtrasMensal"
          class="form-input"
          [class.error]="hasError('valorBeneficiosExtrasMensal')"
          placeholder="Ex: 350.00"
          step="0.01"
        />
        @if (hasError('valorBeneficiosExtrasMensal')) {
        <span class="error-message">{{ getErrorMessage('valorBeneficiosExtrasMensal') }}</span>
        }
      </div>
      </div>


      <h3 class="section-title">üìä Percentuais e Margens</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="percentualAdicionalNoturno" class="form-label">
            Adicional Noturno (%) <span class="required">*</span>
            <span class="info-tooltip" title="Adicional obrigat√≥rio por CLT (Art. 73) para trabalho noturno (22h-5h). M√≠nimo legal: 20%. Recomendado: 20-30% dependendo da conven√ß√£o coletiva.">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </span>
          </label>
          <input
            id="percentualAdicionalNoturno"
            type="number"
            formControlName="percentualAdicionalNoturno"
            class="form-input"
            [class.error]="hasError('percentualAdicionalNoturno')"
            placeholder="Ex: 20.00"
            step="0.01"
            min="0"
            max="100"
          />
          @if (hasError('percentualAdicionalNoturno')) {
          <span class="error-message">{{ getErrorMessage('percentualAdicionalNoturno') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="percentualImpostos" class="form-label">
            Impostos (%) <span class="required">*</span>
            <span class="info-tooltip" title="Encargos sociais e impostos: INSS (20%), FGTS (8%), PIS (0.65%), etc. Total m√©dio: 12-18%. Recomendado: 15% (cobre INSS + FGTS + outros).">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </span>
          </label>
          <input
            id="percentualImpostos"
            type="number"
            formControlName="percentualImpostos"
            class="form-input"
            [class.error]="hasError('percentualImpostos')"
            placeholder="Ex: 15.00"
            step="0.01"
            min="0"
            max="100"
          />
          @if (hasError('percentualImpostos')) {
          <span class="error-message">{{ getErrorMessage('percentualImpostos') }}</span>
          }
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="margemLucroPercentual" class="form-label">
            Margem de Lucro (%) <span class="required">*</span>
            <span class="info-tooltip" title="Percentual de lucro desejado sobre o contrato. Mercado de seguran√ßa: 10-20%. Recomendado: 15% (equilibra competitividade e rentabilidade).">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </span>
          </label>
          <input
            id="margemLucroPercentual"
            type="number"
            formControlName="margemLucroPercentual"
            class="form-input"
            [class.error]="hasError('margemLucroPercentual')"
            placeholder="Ex: 15.00"
            step="0.01"
            min="0"
            max="100"
          />
          @if (hasError('margemLucroPercentual')) {
          <span class="error-message">{{ getErrorMessage('margemLucroPercentual') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="margemCoberturaFaltasPercentual" class="form-label">
            Margem Cobertura de Faltas (%) <span class="required">*</span>
            <span class="info-tooltip" title="Reserva para cobrir custos de faltas, substitui√ß√µes e imprevistos. Recomendado: 8-12%. Valor de 10% cobre aproximadamente 2-3 faltas por m√™s.">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </span>
          </label>
          <input
            id="margemCoberturaFaltasPercentual"
            type="number"
            formControlName="margemCoberturaFaltasPercentual"
            class="form-input"
            [class.error]="hasError('margemCoberturaFaltasPercentual')"
            placeholder="Ex: 10.00"
            step="0.01"
            min="0"
            max="100"
          />
          @if (hasError('margemCoberturaFaltasPercentual')) {
          <span class="error-message">{{
            getErrorMessage('margemCoberturaFaltasPercentual')
          }}</span>
          }
        </div>
      </div>

      <h3 class="section-title">üìÖ Per√≠odo do Contrato</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="dataInicio" class="form-label">
            Data In√≠cio <span class="required">*</span>
          </label>
          <input
            id="dataInicio"
            type="date"
            formControlName="dataInicio"
            class="form-input"
            [class.error]="hasError('dataInicio')"
          />
          @if (hasError('dataInicio')) {
          <span class="error-message">{{ getErrorMessage('dataInicio') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="dataFim" class="form-label">
            Data Fim <span class="required">*</span>
            @if (duracaoContrato()) {
              <span class="duration-badge">üìÖ Dura√ß√£o: {{ duracaoContrato() }}</span>
            }
          </label>
          <input
            id="dataFim"
            type="date"
            formControlName="dataFim"
            class="form-input"
            [class.error]="hasError('dataFim')"
          />
          @if (hasError('dataFim')) {
          <span class="error-message">{{ getErrorMessage('dataFim') }}</span>
          }
        </div>
      </div>

      <div class="form-group">
        <label for="status" class="form-label"> Status <span class="required">*</span> </label>
        <select
          id="status"
          formControlName="status"
          class="form-input"
          [class.error]="hasError('status')"
        >
          @for (opt of statusOptions; track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
          }
        </select>
        @if (hasError('status')) {
        <span class="error-message">{{ getErrorMessage('status') }}</span>
        }
      </div>

      <!-- Breakdown de Custos -->
      @if (temBreakdown || calculando()) {
      <div class="breakdown-section">
        <h3 class="section-title">üìä Breakdown de Custos</h3>

        <!-- Loading -->
        @if (calculando()) {
        <div class="loading-state">
          <span class="spinner"></span>
          <span>Calculando valores...</span>
        </div>
        }

        <!-- Erro -->
        @if (erroCalculo()) {
        <div class="alert alert-error">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd"
            />
          </svg>
          {{ erroCalculo() }}
        </div>
        }

        <!-- Breakdown -->
        @if (breakdown() && !calculando()) {
        <div class="breakdown-grid">
          <div class="breakdown-item total">
            <span class="label">üí∞ Valor Total Mensal</span>
            <span class="value">{{ breakdown()!.valorTotalMensal | currency : 'BRL' }}</span>
          </div>

          <div class="breakdown-item">
            <span class="label">üì¶ Custo Base</span>
            <span class="value">{{ breakdown()!.custoBaseMensal | currency : 'BRL' }}</span>
          </div>

          <div class="breakdown-item">
            <span class="label"
              >üèõÔ∏è Impostos ({{ form.value.percentualImpostos }}%)</span
            >
            <span class="value">{{ breakdown()!.valorImpostos | currency : 'BRL' }}</span>
          </div>

          <div class="breakdown-item">
            <span class="label"
              >üìà Margem Lucro ({{ form.value.margemLucroPercentual }}%)</span
            >
            <span class="value">{{ breakdown()!.valorMargemLucro | currency : 'BRL' }}</span>
          </div>

          <div class="breakdown-item">
            <span class="label"
              >üõ°Ô∏è Margem Faltas ({{ form.value.margemCoberturaFaltasPercentual }}%)</span
            >
            <span class="value">{{ breakdown()!.valorMargemFaltas | currency : 'BRL' }}</span>
          </div>

          <div class="breakdown-item">
            <span class="label">üéÅ Benef√≠cios</span>
            <span class="value">{{ breakdown()!.valorBeneficios | currency : 'BRL' }}</span>
          </div>

          <div class="breakdown-item highlight">
            <span class="label">üíµ Base para Sal√°rios</span>
            <span class="value">{{ breakdown()!.baseParaSalarios | currency : 'BRL' }}</span>
          </div>
        </div>
        }
      </div>
      }

      <!-- Valor Total Calculado (mantido para compatibilidade) -->
      <div class="calculation-result">
        <div class="result-card">
          <div class="result-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"
              />
            </svg>
          </div>
          <div class="result-content">
            <p class="result-label">Valor Total do Contrato</p>
            <h2 class="result-value">{{ valorTotalCalculado | currency : 'BRL' }}</h2>
            <p class="result-info">
              Calculado automaticamente com base nos valores informados
            </p>
          </div>
        </div>
      </div>

      <div class="form-footer">
        <p class="required-note"><span class="required">*</span> Campos obrigat√≥rios</p>
        <div class="button-group">
          <button type="button" class="btn-secondary" (click)="cancel()" [disabled]="loading()">
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="loading()">
            @if (loading()) {
            <span class="spinner-small"></span>
            Salvando... } @else {
            {{ isEdit() ? 'Atualizar' : 'Cadastrar' }}
            }
          </button>
        </div>
      </div>
    </div>
  </form>
</div>
